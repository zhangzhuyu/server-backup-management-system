<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ly.cloud.quartz.mapper.JobAndTriggerMapper">

    <resultMap id="jobdetail" type="com.ly.cloud.quartz.entity.JobAndTrigger">
        <result property="jobName"  jdbcType="VARCHAR"  column="JOB_NAME"/>
        <result property="jobGroup"  jdbcType="VARCHAR"  column="JOB_GROUP"/>
        <result property="jobClassName"  jdbcType="VARCHAR"  column="JOB_CLASS_NAME"/>
        <result property="triggerName"  jdbcType="VARCHAR"  column="TRIGGER_NAME"/>
        <result property="triggerGroup"  jdbcType="VARCHAR"  column="TRIGGER_GROUP"/>
        <result property="prevFireTime"  jdbcType="VARCHAR"  column="PREV_FIRE_TIME"/>
        <result property="nextFireTime"  jdbcType="VARCHAR"  column="NEXT_FIRE_TIME"/>
        <result property="cronExpression"  jdbcType="VARCHAR"  column="CRON_EXPRESSION"/>
        <result property="triggerState"  jdbcType="VARCHAR"  column="TRIGGER_STATE"/>
    </resultMap>


    <select id="queryJobByNameAndGroupName" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM  LY_QRTZ_JOB_DETAILS WHERE JOB_NAME = #{jobName} AND JOB_GROUP = #{jobGroupName}
	</select>


    <select id="getJobAndTriggerDetails" resultMap="jobdetail">
			SELECT
				a.JOB_NAME,
				a.JOB_GROUP,
				a.JOB_CLASS_NAME,
				a.JOB_DATA,
				b.TRIGGER_NAME,
				b.TRIGGER_GROUP,
				case
				WHEN   b.PREV_FIRE_TIME =-1
				THEN '-'
				else DATE_FORMAT(PREV_FIRE_TIME,'%Y-%m-%d %H:%i:%s') END as PREV_FIRE_TIME,
				DATE_FORMAT(NEXT_FIRE_TIME,'%Y-%m-%d %H:%i:%s')  as NEXT_FIRE_TIME,
			    b.TRIGGER_STATE,
				c.CRON_EXPRESSION,
				c.TIME_ZONE_ID
			FROM
				 LY_QRTZ_JOB_DETAILS a
				LEFT JOIN LY_QRTZ_TRIGGERS b ON a.JOB_NAME = b.JOB_NAME
				AND b.TRIGGER_GROUP = a.JOB_GROUP
				LEFT JOIN LY_QRTZ_CRON_TRIGGERS c ON b.TRIGGER_NAME = c.TRIGGER_NAME
				AND b.TRIGGER_GROUP = c.TRIGGER_GROUP
				<where>
					<if test="jobName != null and jobName != '' ">
						and a.JOB_NAME = #{jobName,jdbcType=VARCHAR}
					</if>
					<if test="jobGroupName != null and jobGroupName != '' ">
						and a.JOB_GROUP = #{jobGroupName,jdbcType=VARCHAR}
					</if>
				</where>
    </select>

    <update id="updateTriggerPreTriggerTime" parameterType="java.lang.Long">

		update LY_QRTZ_TRIGGERS set PREV_FIRE_TIME = #{time}

	</update>

</mapper>
